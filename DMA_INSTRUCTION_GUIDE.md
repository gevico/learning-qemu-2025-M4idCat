# G233 Board DMA è½¬ç½®æŒ‡ä»¤å®ç°æ•™å­¦æŒ‡å—

## ğŸ“‹ ä»»åŠ¡æ¦‚è¿°

å®ç°ä¸€ä¸ªè‡ªå®šä¹‰çš„ RISC-V æŒ‡ä»¤ `dma`ï¼Œç”¨äºå°†ä¸€ä¸ª FP32 ç²¾åº¦çš„äºŒç»´çŸ©é˜µä»æºåœ°å€è½¬ç½®åæ¬è¿åˆ°ç›®æ ‡åœ°å€ã€‚

### æŒ‡ä»¤æ ¼å¼

```
31      25 24  20 19    15 14     12  11                7 6     0
+---------+--------+--------+----------+-------------------+-------+
| 0000110 |  rs2   |  rs1   |    110   |         rd        |1111011| dma
+---------+--------+--------+----------+-------------------+-------+
```

- **opcode**: `0x7b` (1111011)
- **funct3**: `6` (110)
- **funct7**: `6` (0000110)
- **rs1**: æºçŸ©é˜µåœ¨å†…å­˜ä¸­çš„èµ·å§‹åœ°å€
- **rs2**: çŸ©é˜µè§„æ¨¡ (0=8x8, 1=16x16, 2=32x32)
- **rd**: ç›®æ ‡çŸ©é˜µåœ¨å†…å­˜ä¸­çš„åœ°å€

---

## ğŸ¯ å®ç°æ­¥éª¤

### æ­¥éª¤ 1: å®šä¹‰æŒ‡ä»¤æ ¼å¼ (insn32.decode)

**æ–‡ä»¶ä½ç½®**: `target/riscv/insn32.decode`

**éœ€è¦æ·»åŠ çš„å†…å®¹**:

åœ¨æ–‡ä»¶æœ«å°¾æ·»åŠ  DMA æŒ‡ä»¤çš„è§£ç å®šä¹‰ã€‚é¦–å…ˆéœ€è¦æ‰¾åˆ°åˆé€‚çš„ä½ç½®ï¼Œé€šå¸¸åœ¨æ–‡ä»¶çš„æœ€åã€‚

```decode
# Custom DMA instruction for G233 Board
dma       0000110  ..... ..... 110 ..... 1111011 @r
```

**è§£é‡Š**:
- `dma`: æŒ‡ä»¤åç§°
- `0000110`: funct7 å­—æ®µ (äºŒè¿›åˆ¶)
- `.....`: rs2 å­—æ®µ (5ä½ï¼Œç”± @r æ ¼å¼å¤„ç†)
- `.....`: rs1 å­—æ®µ (5ä½ï¼Œç”± @r æ ¼å¼å¤„ç†)
- `110`: funct3 å­—æ®µ (äºŒè¿›åˆ¶)
- `.....`: rd å­—æ®µ (5ä½ï¼Œç”± @r æ ¼å¼å¤„ç†)
- `1111011`: opcode å­—æ®µ (äºŒè¿›åˆ¶ = 0x7b)
- `@r`: ä½¿ç”¨ R-type æ ¼å¼ (å·²åœ¨æ–‡ä»¶å¼€å¤´å®šä¹‰)

**æç¤º**: 
- æ‰“å¼€ `target/riscv/insn32.decode` æ–‡ä»¶
- æ»šåŠ¨åˆ°æœ€å
- æ·»åŠ ä¸Šé¢çš„å®šä¹‰

---

### æ­¥éª¤ 2: å®ç°æŒ‡ä»¤ç¿»è¯‘å‡½æ•° (trans_dma.c.inc)

**æ–‡ä»¶ä½ç½®**: `target/riscv/insn_trans/trans_dma.c.inc` (æ–°å»ºæ–‡ä»¶)

**éœ€è¦ç†è§£çš„çŸ¥è¯†ç‚¹**:

#### TCG (Tiny Code Generator)
- QEMU ä½¿ç”¨ TCG å°†ç›®æ ‡æ¶æ„æŒ‡ä»¤ç¿»è¯‘ä¸ºä¸­é—´è¡¨ç¤º (IR)
- ç¿»è¯‘å‡½æ•°å°† RISC-V æŒ‡ä»¤è½¬æ¢ä¸º TCG æ“ä½œ
- TCG æ“ä½œæœ€ç»ˆä¼šè¢«ç¼–è¯‘ä¸ºä¸»æœºä»£ç æ‰§è¡Œ

#### Helper å‡½æ•°
- å¤æ‚çš„æ“ä½œé€šè¿‡ helper å‡½æ•°å®ç°
- Helper å‡½æ•°åœ¨è¿è¡Œæ—¶è¢«è°ƒç”¨ï¼Œæ‰§è¡Œå®é™…çš„æ“ä½œ
- Helper å‡½æ•°å¯ä»¥è®¿é—® CPU çŠ¶æ€å’Œå†…å­˜

#### åˆ›å»ºæ–‡ä»¶å†…å®¹:

```c
/*
 * RISC-V translation routines for the DMA instruction (G233 Board)
 *
 * Copyright (c) 2025 Learning QEMU
 *
 * SPDX-License-Identifier: GPL-2.0-or-later
 */

/*
 * DMA è½¬ç½®æŒ‡ä»¤ç¿»è¯‘å‡½æ•°
 * 
 * è¿™ä¸ªå‡½æ•°åœ¨æŒ‡ä»¤è§£ç åè¢«è°ƒç”¨ï¼Œè´Ÿè´£ç”Ÿæˆå¯¹åº”çš„ TCG ä»£ç 
 * 
 * @ctx: åæ±‡ç¼–ä¸Šä¸‹æ–‡ï¼ŒåŒ…å«å½“å‰æŒ‡ä»¤çš„ä¿¡æ¯
 * @a: æŒ‡ä»¤å‚æ•°ï¼ŒåŒ…å« rd, rs1, rs2 çš„å€¼
 * @return: true è¡¨ç¤ºæŒ‡ä»¤å¤„ç†æˆåŠŸ
 */
static bool trans_dma(DisasContext *ctx, arg_dma *a)
{
    // æ­¥éª¤ 1: å£°æ˜ TCG ä¸´æ—¶å˜é‡
    // TCGv æ˜¯ TCG å˜é‡ç±»å‹ï¼Œç”¨äºå­˜å‚¨å¯„å­˜å™¨å€¼
    TCGv src_addr, dst_addr, grain_size;
    
    // æ­¥éª¤ 2: åˆ†é… TCG ä¸´æ—¶å˜é‡
    // è¿™äº›å˜é‡ä¼šåœ¨ TCG ä»£ç ç”Ÿæˆæ—¶ä½¿ç”¨
    src_addr = tcg_temp_new();
    dst_addr = tcg_temp_new();
    grain_size = tcg_temp_new();
    
    // æ­¥éª¤ 3: ä» RISC-V å¯„å­˜å™¨è¯»å–å€¼åˆ° TCG å˜é‡
    // gen_get_gpr() ç”Ÿæˆè¯»å–é€šç”¨å¯„å­˜å™¨çš„ TCG ä»£ç 
    // a->rs1 åŒ…å«æºåœ°å€
    // a->rd åŒ…å«ç›®æ ‡åœ°å€
    // a->rs2 åŒ…å«çŸ©é˜µè§„æ¨¡å‚æ•°
    gen_get_gpr(ctx, src_addr, a->rs1);
    gen_get_gpr(ctx, dst_addr, a->rd);
    gen_get_gpr(ctx, grain_size, a->rs2);
    
    // æ­¥éª¤ 4: ç”Ÿæˆè°ƒç”¨ helper å‡½æ•°çš„ TCG ä»£ç 
    // gen_helper_dma() ä¼šç”Ÿæˆä¸€ä¸ªå‡½æ•°è°ƒç”¨
    // è¿™ä¸ª helper å‡½æ•°ä¼šåœ¨è¿è¡Œæ—¶æ‰§è¡Œå®é™…çš„ DMA è½¬ç½®æ“ä½œ
    gen_helper_dma(tcg_env, dst_addr, src_addr, grain_size);
    
    // æ­¥éª¤ 5: è¿”å› true è¡¨ç¤ºæŒ‡ä»¤å¤„ç†æˆåŠŸ
    return true;
}
```

**å…³é”®ç‚¹è§£é‡Š**:

1. **arg_dma**: è¿™ä¸ªç»“æ„ä½“ä¼šç”± QEMU çš„ decodetree å·¥å…·è‡ªåŠ¨ç”Ÿæˆï¼ŒåŒ…å« rd, rs1, rs2 å­—æ®µ

2. **gen_get_gpr()**: ç”Ÿæˆä» RISC-V é€šç”¨å¯„å­˜å™¨è¯»å–å€¼çš„ TCG ä»£ç 
   - åœ¨ç¿»è¯‘æ—¶ç”Ÿæˆä»£ç ï¼Œä½†å®é™…è¯»å–åœ¨è¿è¡Œæ—¶å‘ç”Ÿ

3. **gen_helper_dma()**: è°ƒç”¨ helper å‡½æ•°
   - `tcg_env`: CPU ç¯å¢ƒæŒ‡é’ˆï¼Œç”¨äºè®¿é—® CPU çŠ¶æ€
   - ä¸‰ä¸ªå‚æ•°æŒ‰é¡ºåºä¼ é€’ç»™ helper å‡½æ•°

---

### æ­¥éª¤ 3: å£°æ˜ Helper å‡½æ•° (helper.h)

**æ–‡ä»¶ä½ç½®**: `target/riscv/helper.h`

**éœ€è¦æ·»åŠ çš„å†…å®¹**:

åœ¨æ–‡ä»¶ä¸­æ‰¾åˆ°åˆé€‚çš„ä½ç½®ï¼ˆé€šå¸¸åœ¨æ–‡ä»¶æœ«å°¾ï¼‰ï¼Œæ·»åŠ  helper å‡½æ•°å£°æ˜ã€‚

```c
/* Custom DMA instruction for G233 Board */
DEF_HELPER_4(dma, void, env, tl, tl, tl)
```

**è§£é‡Š**:
- `DEF_HELPER_4`: å®šä¹‰ä¸€ä¸ªæœ‰ 4 ä¸ªå‚æ•°çš„ helper å‡½æ•°
  - å‚æ•°æ•°é‡åŒ…æ‹¬è¿”å›å€¼å’Œæ‰€æœ‰è¾“å…¥å‚æ•°
  - 4 = 1 (env) + 3 (dst_addr, src_addr, grain_size)
  
- `dma`: helper å‡½æ•°åç§°ï¼ˆä¼šè‡ªåŠ¨åŠ ä¸Š `helper_` å‰ç¼€ï¼‰

- `void`: è¿”å›ç±»å‹

- `env, tl, tl, tl`: å‚æ•°ç±»å‹åˆ—è¡¨
  - `env`: CPU ç¯å¢ƒæŒ‡é’ˆ
  - `tl`: target_longï¼Œç›®æ ‡æ¶æ„çš„é•¿æ•´å‹ï¼ˆåœ¨ RISC-V 64 ä¸Šæ˜¯ 64 ä½ï¼‰
  
**æç¤º**: åœ¨ `target/riscv/helper.h` ä¸­æœç´¢å…¶ä»– `DEF_HELPER` å®šä¹‰ä½œä¸ºå‚è€ƒã€‚

---

### æ­¥éª¤ 4: å®ç° Helper å‡½æ•° (op_helper.c)

**æ–‡ä»¶ä½ç½®**: `target/riscv/op_helper.c`

**éœ€è¦ç†è§£çš„çŸ¥è¯†ç‚¹**:

#### å†…å­˜è®¿é—®
- QEMU æä¾›äº†å®‰å…¨çš„å†…å­˜è®¿é—®å‡½æ•°
- `cpu_ldl_data_ra()`: ä»å®¢æˆ·æœºå†…å­˜è¯»å– 32 ä½æ•°æ®
- `cpu_stl_data_ra()`: å‘å®¢æˆ·æœºå†…å­˜å†™å…¥ 32 ä½æ•°æ®
- `ra` å‚æ•°ç”¨äºå¼‚å¸¸å¤„ç†æ—¶çš„è¿”å›åœ°å€

#### çŸ©é˜µè½¬ç½®ç®—æ³•
```
åŸçŸ©é˜µ A (MÃ—N):     è½¬ç½®çŸ©é˜µ C (NÃ—M):
[a00 a01 a02]       [a00 a10 a20]
[a10 a11 a12]  =>   [a01 a11 a21]
[a20 a21 a22]       [a02 a12 a22]

C[i][j] = A[j][i]
C[i * M + j] = A[j * N + i]
```

#### å®ç°ä»£ç :

```c
/*
 * DMA è½¬ç½® Helper å‡½æ•°
 * 
 * è¿™ä¸ªå‡½æ•°åœ¨è¿è¡Œæ—¶è¢«è°ƒç”¨ï¼Œæ‰§è¡Œå®é™…çš„çŸ©é˜µè½¬ç½®å’Œæ•°æ®æ¬è¿
 * 
 * @env: RISC-V CPU ç¯å¢ƒï¼Œç”¨äºè®¿é—®å†…å­˜
 * @dst_addr: ç›®æ ‡åœ°å€ (æ¥è‡ª rd å¯„å­˜å™¨)
 * @src_addr: æºåœ°å€ (æ¥è‡ª rs1 å¯„å­˜å™¨)  
 * @grain_size: çŸ©é˜µè§„æ¨¡å‚æ•° (æ¥è‡ª rs2 å¯„å­˜å™¨)
 *              0 = 8x8, 1 = 16x16, 2 = 32x32
 */
void helper_dma(CPURISCVState *env, target_ulong dst_addr,
                target_ulong src_addr, target_ulong grain_size)
{
    // æ­¥éª¤ 1: æ ¹æ® grain_size ç¡®å®šçŸ©é˜µå¤§å°
    // ä½¿ç”¨ä½ç§»è¿ç®—: size = 8 << grain_size
    // grain_size=0: 8<<0 = 8
    // grain_size=1: 8<<1 = 16
    // grain_size=2: 8<<2 = 32
    int M, N;
    M = N = 8 << grain_size;
    
    // æ­¥éª¤ 2: è·å–è¿”å›åœ°å€ï¼Œç”¨äºå¼‚å¸¸å¤„ç†
    // GETPC() è·å–å½“å‰çš„ç¨‹åºè®¡æ•°å™¨ï¼Œç”¨äºå¼‚å¸¸æ—¶å›æº¯
    uintptr_t ra = GETPC();
    
    // æ­¥éª¤ 3: æ‰§è¡ŒçŸ©é˜µè½¬ç½®
    // åŒé‡å¾ªç¯éå†çŸ©é˜µçš„æ¯ä¸ªå…ƒç´ 
    for (int i = 0; i < N; i++) {
        for (int j = 0; j < M; j++) {
            // æ­¥éª¤ 3.1: è®¡ç®—æºåœ°å€åç§»
            // æºçŸ©é˜µæ˜¯ MÃ—Nï¼ŒæŒ‰è¡Œå­˜å‚¨
            // A[j][i] çš„åç§» = (j * N + i) * sizeof(uint32_t)
            // sizeof(uint32_t) = 4 å­—èŠ‚ (FP32)
            target_ulong src_offset = (j * N + i) * 4;
            
            // æ­¥éª¤ 3.2: ä»æºåœ°å€è¯»å–æ•°æ®
            // cpu_ldl_data_ra() è¯»å– 32 ä½æ•°æ® (little-endian)
            // å‚æ•°: CPUç¯å¢ƒ, åœ°å€, å†…å­˜è®¿é—®æƒé™, è¿”å›åœ°å€
            uint32_t value = cpu_ldl_data_ra(env, src_addr + src_offset,
                                             GETPC());
            
            // æ­¥éª¤ 3.3: è®¡ç®—ç›®æ ‡åœ°å€åç§»
            // ç›®æ ‡çŸ©é˜µæ˜¯ NÃ—Mï¼ŒæŒ‰è¡Œå­˜å‚¨
            // C[i][j] çš„åç§» = (i * M + j) * sizeof(uint32_t)
            target_ulong dst_offset = (i * M + j) * 4;
            
            // æ­¥éª¤ 3.4: å‘ç›®æ ‡åœ°å€å†™å…¥æ•°æ®
            // cpu_stl_data_ra() å†™å…¥ 32 ä½æ•°æ® (little-endian)
            // å‚æ•°: CPUç¯å¢ƒ, åœ°å€, æ•°æ®, å†…å­˜è®¿é—®æƒé™, è¿”å›åœ°å€
            cpu_stl_data_ra(env, dst_addr + dst_offset, value, ra);
        }
    }
}
```

**å…³é”®ç‚¹è§£é‡Š**:

1. **å†…å­˜è®¿é—®å‡½æ•°**:
   - `cpu_ldl_data_ra()`: load 32-bit little-endian
   - `cpu_stl_data_ra()`: store 32-bit little-endian
   - è¿™äº›å‡½æ•°ä¼šå¤„ç†å†…å­˜æ˜ å°„ã€æƒé™æ£€æŸ¥ç­‰

2. **åœ°å€è®¡ç®—**:
   - äºŒç»´æ•°ç»„åœ¨å†…å­˜ä¸­æ˜¯è¿ç»­å­˜å‚¨çš„
   - `A[i][j]` åœ¨å†…å­˜ä¸­çš„ä½ç½® = base + (i * åˆ—æ•° + j) * å…ƒç´ å¤§å°

3. **è½¬ç½®é€»è¾‘**:
   - è¯»å– `A[j][i]`ï¼Œå†™å…¥ `C[i][j]`
   - è¿™æ ·å°±å®ç°äº†çŸ©é˜µè½¬ç½®

---

### æ­¥éª¤ 5: åŒ…å«ç¿»è¯‘æ–‡ä»¶ (translate.c)

**æ–‡ä»¶ä½ç½®**: `target/riscv/translate.c`

**éœ€è¦æ·»åŠ çš„å†…å®¹**:

åœ¨æ–‡ä»¶ä¸­æ‰¾åˆ°å…¶ä»– `#include "insn_trans/trans_*.c.inc"` çš„ä½ç½®ï¼Œæ·»åŠ ï¼š

```c
#include "insn_trans/trans_dma.c.inc"
```

**å»ºè®®ä½ç½®**: åœ¨ `#include "insn_trans/trans_rvi.c.inc"` ä¹‹å

**è§£é‡Š**:
- è¿™æ ·å¯ä»¥å°† DMA æŒ‡ä»¤çš„ç¿»è¯‘å‡½æ•°åŒ…å«åˆ°ä¸»ç¿»è¯‘å™¨ä¸­
- QEMU ä¼šåœ¨è§£ç åˆ° `dma` æŒ‡ä»¤æ—¶è°ƒç”¨ `trans_dma()` å‡½æ•°

---

### æ­¥éª¤ 6: æ·»åŠ åæ±‡ç¼–æ”¯æŒ (å¯é€‰ä½†æ¨è)

**æ–‡ä»¶ä½ç½®**: `disas/riscv.c`

è¿™ä¸€æ­¥æ˜¯å¯é€‰çš„ï¼Œä½†å¯ä»¥è®© QEMU åœ¨åæ±‡ç¼–æ—¶æ­£ç¡®æ˜¾ç¤º DMA æŒ‡ä»¤ã€‚

#### 6.1 æ·»åŠ æ“ä½œç æšä¸¾

åœ¨ `rv_op` æšä¸¾ä¸­æ·»åŠ :

```c
typedef enum {
    // ... ç°æœ‰çš„æšä¸¾å€¼ ...
    rv_op_dma,          // æ·»åŠ è¿™ä¸€è¡Œ
} rv_opcode;
```

#### 6.2 æ·»åŠ æ“ä½œç åç§°

åœ¨æ“ä½œç åç§°æ•°ç»„ä¸­æ·»åŠ :

```c
static const char *rv_op_name[] = {
    // ... ç°æœ‰çš„åç§° ...
    "dma",              // æ·»åŠ è¿™ä¸€è¡Œï¼Œä½ç½®è¦å’Œæšä¸¾å¯¹åº”
};
```

#### 6.3 æ·»åŠ è§£ç é€»è¾‘

åœ¨ `decode_inst_opcode()` å‡½æ•°ä¸­æ·»åŠ è§£ç é€»è¾‘ã€‚æ‰¾åˆ° opcode `0x7b` çš„å¤„ç†éƒ¨åˆ†:

```c
case 0x7b:  // custom-3 opcode
    switch ((inst >> 12) & 0b111) {  // funct3
    case 6:  // funct3 = 110
        switch ((inst >> 25) & 0b1111111) {  // funct7
        case 6:  // funct7 = 0000110
            op = rv_op_dma;
            break;
        }
        break;
    }
    break;
```

#### 6.4 æ·»åŠ æ ¼å¼åŒ–è¾“å‡º

åœ¨ `format_inst()` å‡½æ•°ä¸­æ·»åŠ :

```c
case rv_op_dma:
    format_r(buf, sizeof(buf), "dma", dec);
    break;
```

**è§£é‡Š**: è¿™æ ·å½“ä½¿ç”¨ QEMU çš„åæ±‡ç¼–åŠŸèƒ½æ—¶ï¼Œä¼šæ­£ç¡®æ˜¾ç¤º `dma rd, rs1, rs2`

---

## ğŸ”§ ç¼–è¯‘å’Œæµ‹è¯•

### ç¼–è¯‘æ­¥éª¤

```bash
# 1. é…ç½® (å¦‚æœè¿˜æ²¡æœ‰é…ç½®)
./configure --target-list=riscv64-softmmu,riscv64-linux-user

# 2. ç¼–è¯‘
make -j$(nproc)

# 3. ç¼–è¯‘æµ‹è¯•ç¨‹åº
cd tests/gevico/tcg
make -C riscv64
```

### æµ‹è¯•æ–¹æ³•

```bash
# æ–¹å¼ 1: ä½¿ç”¨ linux-user æ¨¡å¼æµ‹è¯•
./build/qemu-riscv64 tests/gevico/tcg/riscv64/test-insn-dma

# æ–¹å¼ 2: ä½¿ç”¨ system æ¨¡å¼ (éœ€è¦å®Œæ•´çš„ç³»ç»Ÿé•œåƒ)
./build/qemu-system-riscv64 -M g233 -kernel <kernel-image> -nographic
```

### é¢„æœŸè¾“å‡º

å¦‚æœå®ç°æ­£ç¡®ï¼Œåº”è¯¥çœ‹åˆ°ç±»ä¼¼çš„è¾“å‡º:

```
A = 
   0    1    2    3    4    5    6    7 
   8    9   10   11   12   13   14   15 
  16   17   18   19   20   21   22   23 
  24   25   26   27   28   29   30   31 
  32   33   34   35   36   37   38   39 
  40   41   42   43   44   45   46   47 
  48   49   50   51   52   53   54   55 
  56   57   58   59   60   61   62   63 

Grain: 8x8, compare sucessful!
Grain: 16x16, compare sucessful!
Grain: 32x32, compare sucessful!
```

---

## ğŸ› è°ƒè¯•æŠ€å·§

### 1. æ£€æŸ¥æŒ‡ä»¤æ˜¯å¦è¢«æ­£ç¡®è§£ç 

```bash
# ä½¿ç”¨ -d in_asm æŸ¥çœ‹ç¿»è¯‘çš„æŒ‡ä»¤
./build/qemu-riscv64 -d in_asm tests/gevico/tcg/riscv64/test-insn-dma
```

åº”è¯¥èƒ½çœ‹åˆ°ç±»ä¼¼:
```
IN: 
0x... : 06c5e7bb  dma a5, a1, a2
```

### 2. æ£€æŸ¥ TCG ä»£ç ç”Ÿæˆ

```bash
# ä½¿ç”¨ -d op æŸ¥çœ‹ç”Ÿæˆçš„ TCG IR
./build/qemu-riscv64 -d op tests/gevico/tcg/riscv64/test-insn-dma
```

### 3. è¿½è¸ªå†…å­˜è®¿é—®

```bash
# ä½¿ç”¨ -d cpu,exec æŸ¥çœ‹ CPU çŠ¶æ€å’Œæ‰§è¡Œæµç¨‹
./build/qemu-riscv64 -d cpu,exec tests/gevico/tcg/riscv64/test-insn-dma
```

### 4. å¸¸è§é”™è¯¯

#### é”™è¯¯ 1: ç¼–è¯‘é”™è¯¯ "unknown type name 'arg_dma'"
**åŸå› **: decodetree æ²¡æœ‰ç”Ÿæˆå¯¹åº”çš„ç»“æ„ä½“
**è§£å†³**: æ£€æŸ¥ `insn32.decode` ä¸­çš„å®šä¹‰æ˜¯å¦æ­£ç¡®

#### é”™è¯¯ 2: é“¾æ¥é”™è¯¯ "undefined reference to `helper_dma'"
**åŸå› **: helper å‡½æ•°æ²¡æœ‰æ­£ç¡®å®ç°æˆ–é“¾æ¥
**è§£å†³**: æ£€æŸ¥ `op_helper.c` å’Œ `helper.h` ä¸­çš„å®šä¹‰

#### é”™è¯¯ 3: è¿è¡Œæ—¶æ®µé”™è¯¯
**åŸå› **: å†…å­˜è®¿é—®è¶Šç•Œ
**è§£å†³**: æ£€æŸ¥åœ°å€è®¡ç®—é€»è¾‘ï¼Œç¡®ä¿ä¸è¶…å‡ºçŸ©é˜µèŒƒå›´

---

## ğŸ“š æ‰©å±•å­¦ä¹ 

### 1. ç†è§£ QEMU çš„ç¿»è¯‘æµç¨‹

```
å®¢æˆ·æœºæŒ‡ä»¤ -> è§£ç  -> TCG IR -> ä¸»æœºä»£ç 
   dma    -> decode -> gen_helper_dma -> x86/ARM ä»£ç 
```

### 2. TCG æ“ä½œç±»å‹

- **tcg_gen_***: ç”Ÿæˆ TCG æ“ä½œçš„å‡½æ•°
- **gen_helper_***: ç”Ÿæˆè°ƒç”¨ helper å‡½æ•°çš„ä»£ç 
- **gen_get_gpr/gen_set_gpr**: è¯»å†™é€šç”¨å¯„å­˜å™¨

### 3. å†…å­˜è®¿é—® API

| å‡½æ•° | ç”¨é€” |
|------|------|
| `cpu_ldub_data` | è¯»å– 8 ä½æ— ç¬¦å·æ•° |
| `cpu_lduw_data` | è¯»å– 16 ä½æ— ç¬¦å·æ•° |
| `cpu_ldl_data` | è¯»å– 32 ä½æ•° |
| `cpu_ldq_data` | è¯»å– 64 ä½æ•° |
| `cpu_stb_data` | å†™å…¥ 8 ä½æ•° |
| `cpu_stw_data` | å†™å…¥ 16 ä½æ•° |
| `cpu_stl_data` | å†™å…¥ 32 ä½æ•° |
| `cpu_stq_data` | å†™å…¥ 64 ä½æ•° |

### 4. ä¼˜åŒ–å»ºè®®

å½“å‰å®ç°æ˜¯æ•™å­¦ç‰ˆæœ¬ï¼Œå®é™…åº”ç”¨å¯ä»¥ä¼˜åŒ–ï¼š

1. **æ‰¹é‡å†…å­˜è®¿é—®**: ä½¿ç”¨ `address_space_rw()` è¿›è¡Œæ‰¹é‡è¯»å†™
2. **SIMD ä¼˜åŒ–**: åˆ©ç”¨ä¸»æœºçš„ SIMD æŒ‡ä»¤åŠ é€Ÿè½¬ç½®
3. **å¼‚æ­¥ DMA**: å®ç°çœŸæ­£çš„å¼‚æ­¥ DMA æ“ä½œ
4. **ç¼“å­˜ä¼˜åŒ–**: è€ƒè™‘ç¼“å­˜è¡Œå¯¹é½ï¼Œæé«˜æ€§èƒ½

---

## âœ… å®Œæˆæ£€æŸ¥æ¸…å•

- [ ] åœ¨ `insn32.decode` ä¸­æ·»åŠ  DMA æŒ‡ä»¤å®šä¹‰
- [ ] åˆ›å»º `trans_dma.c.inc` å¹¶å®ç°ç¿»è¯‘å‡½æ•°
- [ ] åœ¨ `helper.h` ä¸­å£°æ˜ helper å‡½æ•°
- [ ] åœ¨ `op_helper.c` ä¸­å®ç° helper å‡½æ•°
- [ ] åœ¨ `translate.c` ä¸­åŒ…å« `trans_dma.c.inc`
- [ ] (å¯é€‰) åœ¨ `disas/riscv.c` ä¸­æ·»åŠ åæ±‡ç¼–æ”¯æŒ
- [ ] ç¼–è¯‘ QEMU
- [ ] è¿è¡Œæµ‹è¯•ç¨‹åºå¹¶éªŒè¯ç»“æœ

---

## ğŸ“ æ€»ç»“

é€šè¿‡å®ç°è¿™ä¸ª DMA è½¬ç½®æŒ‡ä»¤ï¼Œä½ å­¦ä¹ äº†:

1. **RISC-V æŒ‡ä»¤æ ¼å¼**: R-type æŒ‡ä»¤çš„ç¼–ç æ–¹å¼
2. **QEMU æŒ‡ä»¤è§£ç **: decodetree å·¥å…·çš„ä½¿ç”¨
3. **TCG ç¿»è¯‘**: ä»æŒ‡ä»¤åˆ° TCG IR çš„è½¬æ¢
4. **Helper å‡½æ•°**: å¤æ‚æ“ä½œçš„å®ç°æ–¹å¼
5. **å†…å­˜è®¿é—®**: QEMU ä¸­å®‰å…¨çš„å®¢æˆ·æœºå†…å­˜è®¿é—®
6. **çŸ©é˜µè¿ç®—**: è½¬ç½®ç®—æ³•çš„å®ç°

è¿™äº›çŸ¥è¯†å¯ä»¥å¸®åŠ©ä½ :
- æ·»åŠ æ›´å¤šè‡ªå®šä¹‰æŒ‡ä»¤
- ç†è§£ QEMU çš„å·¥ä½œåŸç†
- è¿›è¡Œ CPU æ¨¡æ‹Ÿå’ŒéªŒè¯
- å¼€å‘ç¡¬ä»¶åŠ é€Ÿå™¨

ç»§ç»­åŠ æ²¹ï¼ğŸš€
